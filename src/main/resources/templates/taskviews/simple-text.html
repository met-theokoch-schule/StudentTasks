
<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${task.title}">Aufgabe</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/custom.css}" rel="stylesheet">
</head>
<body>
    <div class="container mt-4">
        <!-- Task Header -->
        <div class="task-header mb-4">
            <h2 th:text="${task.title}">Aufgabentitel</h2>
            <div class="task-description border p-3 mb-3" th:utext="${renderedDescription}">
                <!-- Hier wird der Markdown-Text als HTML gerendert -->
            </div>
        </div>

        <!-- Submission Area -->
        <div class="submission-area">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Ihre Antwort</h5>
                </div>
                <div class="card-body">
                    <textarea id="submission-content" class="form-control" rows="15" 
                              placeholder="Geben Sie hier Ihre Antwort ein..."></textarea>
                    
                    <div class="mt-3 d-flex gap-2">
                        <button id="save-btn" class="btn btn-secondary" onclick="saveContent()">
                            <i class="fas fa-save"></i> Speichern
                        </button>
                        <button id="submit-btn" class="btn btn-success" onclick="submitTask()">
                            <i class="fas fa-paper-plane"></i> Abgeben
                        </button>
                    </div>
                    
                    <div id="status-message" class="mt-2"></div>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    <script>
        const taskId = /*[[${task.id}]]*/ 1;
        let currentContent = '';
        let isSubmitted = false;

        // Load existing content on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadContent();
        });

        // Load current content
        function loadContent() {
            fetch(`/api/tasks/${taskId}/content`)
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    } else if (response.status === 404) {
                        // No content yet, use default submission if available
                        return /*[[${task.defaultSubmission ?: ''}]]*/ '';
                    }
                    throw new Error('Failed to load content');
                })
                .then(content => {
                    document.getElementById('submission-content').value = content;
                    currentContent = content;
                    showStatus('Inhalt geladen', 'success');
                })
                .catch(error => {
                    console.error('Error loading content:', error);
                    showStatus('Fehler beim Laden des Inhalts', 'error');
                });
        }

        // Save content as draft
        function saveContent() {
            const content = document.getElementById('submission-content').value;
            
            fetch(`/api/tasks/${taskId}/content`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'text/plain',
                },
                body: content
            })
            .then(response => {
                if (response.ok) {
                    currentContent = content;
                    showStatus('Entwurf gespeichert', 'success');
                } else {
                    throw new Error('Failed to save content');
                }
            })
            .catch(error => {
                console.error('Error saving content:', error);
                showStatus('Fehler beim Speichern', 'error');
            });
        }

        // Submit task
        function submitTask() {
            const content = document.getElementById('submission-content').value;
            
            if (!content.trim()) {
                showStatus('Bitte geben Sie eine Antwort ein', 'error');
                return;
            }

            if (confirm('Möchten Sie die Aufgabe wirklich abgeben? Dies kann nicht rückgängig gemacht werden.')) {
                // First save the content
                fetch(`/api/tasks/${taskId}/content`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'text/plain',
                    },
                    body: content
                })
                .then(response => {
                    if (!response.ok) throw new Error('Failed to save content');
                    
                    // Then submit the task
                    return fetch(`/api/tasks/${taskId}/submit`, {
                        method: 'POST'
                    });
                })
                .then(response => {
                    if (response.ok) {
                        isSubmitted = true;
                        document.getElementById('submission-content').disabled = true;
                        document.getElementById('save-btn').disabled = true;
                        document.getElementById('submit-btn').disabled = true;
                        showStatus('Aufgabe erfolgreich abgegeben!', 'success');
                    } else {
                        throw new Error('Failed to submit task');
                    }
                })
                .catch(error => {
                    console.error('Error submitting task:', error);
                    showStatus('Fehler beim Abgeben der Aufgabe', 'error');
                });
            }
        }

        // Show status message
        function showStatus(message, type) {
            const statusEl = document.getElementById('status-message');
            statusEl.className = `alert alert-${type === 'success' ? 'success' : 'danger'}`;
            statusEl.textContent = message;
            statusEl.style.display = 'block';
            
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 3000);
        }

        // Auto-save every 30 seconds
        setInterval(() => {
            const content = document.getElementById('submission-content').value;
            if (content !== currentContent && !isSubmitted) {
                saveContent();
            }
        }, 30000);
    </script>
</body>
</html>
