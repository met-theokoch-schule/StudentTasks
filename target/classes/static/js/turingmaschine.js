var Q=Object.defineProperty;var tt=(a,t,e)=>t in a?Q(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var T=(a,t,e)=>tt(a,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))n(s);new MutationObserver(s=>{for(const r of s)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&n(i)}).observe(document,{childList:!0,subtree:!0});function e(s){const r={};return s.integrity&&(r.integrity=s.integrity),s.referrerPolicy&&(r.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?r.credentials="include":s.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function n(s){if(s.ep)return;s.ep=!0;const r=e(s);fetch(s.href,r)}})();var p;let l=(p=class{static updateFromInputs(){const t=e=>{var n;return(n=document.getElementById(e))==null?void 0:n.value};this.LEFT=t("leftSymbolInput")||this.LEFT,this.RIGHT=t("rightSymbolInput")||this.RIGHT,this.BLANK=t("blankSymbolInput")||this.BLANK,this.INIT_STATE=t("initStateInput")||this.INIT_STATE,this.HALT_STATE=t("haltStateInput")||this.HALT_STATE,this.COMMENT_PREFIX=t("commentSymbolInput")||this.COMMENT_PREFIX,this.MAX_STATES=parseInt(t("maxStatesInput"))||this.MAX_STATES,this.MAX_TAPE_LEN=parseInt(t("maxTapeLenInput"))||this.MAX_TAPE_LEN,this.MAX_STATE_SIZE=parseInt(t("maxStateSizeInput"))||this.MAX_STATE_SIZE,this.TRANSITION_SIZE=parseInt(t("transitionSizeInput"))||this.TRANSITION_SIZE}static getTimestamp(){return performance.now()/1e3}static getCurrentMemoryMB(){return performance.memory?(performance.memory.usedJSHeapSize/(1024*1024)).toFixed(2):"N/A"}parseTransitionRules(t){const e=[],n=t.split(`
`),s=p.COMMENT_PREFIX;for(const r of n){const i=r.trim();if(!i||i.startsWith(s))continue;const o=i.split(s)[0].trim(),u=o.split(/\s+/).filter(d=>d.trim());if(u.length!==5)throw new Error(`Invalid transition: "${o}". Expected 5 elements, got ${u.length}`);const[m,E,f,c,S]=u;if(S!==p.LEFT&&S!==p.RIGHT)throw new Error(`Invalid move direction: '${S}' in line "${o}". Must be '${p.LEFT}' or '${p.RIGHT}'.`);for(const[d,h]of[[E,"current"],[c,"new"]])if(d.length!==1)throw new Error(`Invalid ${h}_symbol '${d}'. Must be a single character.`);e.push([m,E,f,c,S])}if(e.length===0)throw new Error("Keine gültigen Übergangsregeln gefunden.");if(e.length>p.TRANSITION_SIZE)throw new Error(`Too many transition rules: ${e.length}. Maximum allowed rules is ${p.TRANSITION_SIZE}.`);return e}},T(p,"LEFT","L"),T(p,"RIGHT","R"),T(p,"BLANK","_"),T(p,"INIT_STATE","INIT"),T(p,"HALT_STATE","HALT"),T(p,"COMMENT_PREFIX","//"),T(p,"MAX_STATES",1024),T(p,"MAX_TAPE_LEN",1048576),T(p,"MAX_STATE_SIZE",32),T(p,"TRANSITION_SIZE",71e4),p),et=class{constructor(t,e=l.INIT_STATE,n=l.HALT_STATE,s=l.BLANK){this.init_state=e,this.halt_state=n,this.blank_symbol=s,this.MAX_STATES=l.MAX_STATES,this.MAX_STATE_SIZE=l.MAX_STATE_SIZE,this.transitions_list=t,this.transitions_dict=this._buildTransitionDict(t,e,n),this.used_tranistions=new Set,this.head_position=0,this.current_state=e,this.tape={},this.running=!0,this.input_tape=""}_validateTransition(t){if(t.length!==5)throw new Error(`Invalid transition: ${t}. Expected 5 elements: (currentState, currentSymbol, newState, newSymbol, moveDirection).`);const[e,n,s,r,i]=t;if(i!==l.LEFT&&i!==l.RIGHT)throw new Error(`Invalid move direction: '${i}'. Must be '${l.LEFT}' or '${l.RIGHT}'.`);for(const[o,u]of[[n,"current"],[r,"new"]])if(o.length!==1)throw new Error(`Invalid ${u}_symbol: '${o}'. Must be a single character.`);for(const[o,u]of[[e,"current"],[s,"new"]])if(o.length>this.MAX_STATE_SIZE)throw new Error(`Invalid ${u}_state: ${o} size=${o.length}. State Size must be less than ${this.MAX_STATE_SIZE} characters.`);return t}_buildTransitionDict(t,e,n){const s={};let r=!1;for(const i of t){const[o,u,m,E,f]=this._validateTransition(i);if(s[o]||(s[o]={}),u in s[o])throw new Error(`Duplicate transition for state ${o} and symbol ${u}`);s[o][u]=[m,E,f],m===n&&(r=!0)}if(Object.keys(s).length>this.MAX_STATES)throw new Error(`Too many states: ${Object.keys(s).length}. Maximum is ${this.MAX_STATES}.`);if(!s[e])throw new Error(`Initial state ${e} not found in the transitions`);if(!r)throw new Error(`Halt state ${n} not found in the transitions`);return s}_setTape(t){if(t.includes(" "))throw new Error("Input tape must not contain spaces");if(this.tape={},this.input_tape=t,this.headMove="N",this.head_position=0,this.current_state=this.init_state,t.length>l.MAX_TAPE_LEN)throw new Error(`Input Tape size is : ${t.length}. Maximum tape size allowed is ${l.MAX_TAPE_LEN}.`);for(let e=0;e<t.length;e++){const n=t[e];n!==this.blank_symbol&&(this.tape[e]=n)}}_getTapeBoundaries(t=5){const e=Object.keys(this.tape).map(Number);let n=e.length>0?Math.min(...e):this.head_position-t,s=e.length>0?Math.max(...e):this.head_position+t;return n=Math.min(n,this.head_position)-t,s=Math.max(s,this.head_position)+t,[n,s]}_printTapeState(t=!0){const[e,n]=this._getTapeBoundaries(),s=this.head_position-e;let r="";for(let m=e;m<=n;m++)r+=this.tape[m]??this.blank_symbol;const i=`${" ".repeat(s)}^`,o=`[${this.stepCount||0}]: ${this.current_state}`;return t&&console.log([r,i,o,""].join(`
`)),r.replace(new RegExp(`^${this.blank_symbol}+|${this.blank_symbol}+$`,"g"),"")}_stepLogic(){const t=this.transitions_dict[this.current_state];if(!t)throw new Error(`No transitions for state ${this.current_state} with input tape ${this.input_tape}`);const e=this.tape[this.head_position]??this.blank_symbol,n=t[e];if(!n)throw new Error(`Keine Übergangsregel für Symbol '${e}' im Zustand ${this.current_state}`);const[s,r,i]=n;r===this.blank_symbol?delete this.tape[this.head_position]:this.tape[this.head_position]=r,this.used_tranistions.add(this.current_state);const o=i===l.LEFT?-1:1;this.current_state=s,this.head_position+=o,this.headMove=i}runLogic(t,e=1e6,n=!1){this.input_tape=t,this._setTape(t),this._printTapeState(n),this.stepCount=0;let s="";for(;this.running&&this.stepCount<e;){if(this.current_state===this.halt_state){this.running=!1,n&&console.log(`HALTED after ${this.stepCount} steps`);continue}this._stepLogic(),this.stepCount++,s=this._printTapeState(n)}return[s,this.stepCount,this.transitions_list.length]}async runIncrementally(t,e=!0,n=1e6){console.log("Turing Machine Initialized:"),console.log(`Enter [space] to step, number to step n times, or q to quit:
`),this.stepCount=0;let s="";for(this.input_tape=t,this._setTape(t),this._printTapeState(e);this.running&&this.stepCount<n;){if(this.current_state===this.halt_state){this.running=!1,e&&console.log(`HALTED after ${this.stepCount} steps`);break}const r=await new Promise(i=>{process.stdin.resume(),process.stdin.setEncoding("utf8"),process.stdin.once("data",o=>i(o.trim()))});if(r==="q"){console.log("Machine Stopped Manually");break}else if(r===""||r===" ")this._stepLogic(),this.stepCount++,s=this._printTapeState(e);else if(/^\d+$/.test(r)){const i=parseInt(r,10);for(let o=0;o<i&&!(this.current_state===this.halt_state||!this.running);o++)this._stepLogic(),this.stepCount++,s=this._printTapeState(e)}else console.log(`Unrecognized key: '${r}'`)}return[s,this.stepCount,this.transitions_list.length]}};class nt{constructor(t,e,n){this.gui=t,this.getRulesText=e,this.setRulesText=n}getCPU(){return this.gui.cpu}setCPU(t){this.gui.cpu=t}copyText(t,e){const n=typeof t=="string"?t:t.value||t.textContent||"";if(!n.trim()){alert(`No ${e} to copy`);return}navigator.clipboard.writeText(n).then(()=>alert(`${e} copied to clipboard`)).catch(s=>{console.error(`Failed to copy ${e}:`,s),alert(`Failed to copy ${e}. Please try again.`)})}clearText(t,e,n=null){confirm(`Clear ${e}?`)&&(n?n(""):typeof t=="string"?document.getElementById(t).value="":(t instanceof HTMLInputElement||t instanceof HTMLTextAreaElement)&&(t.value=""))}async loadStateFromPath(t){try{const e=await fetch(t);if(!e.ok)throw new Error(`Failed to fetch: ${e.status}`);const n=await e.json(),s=new Blob([JSON.stringify(n)],{type:"application/json"});return new File([s],t.split("/").pop())}catch(e){throw console.error("Error loading template:",e),this.updateMachineStatus(`Template load failed: ${e.message}`,"text-danger"),e}}saveState(){var S;const{LEFT:t,RIGHT:e,BLANK:n,INIT_STATE:s,HALT_STATE:r,COMMENT_PREFIX:i,MAX_STATES:o,MAX_TAPE_LEN:u,MAX_STATE_SIZE:m,TRANSITION_SIZE:E}=TuringConfig,f=this.getCPU(),c=f?{head_position:f.head_position,current_state:f.current_state,input_tape:f.input_tape,running:f.running,tape:f.tape}:{};return{name:this.gui.modelName,rulesText:this.getRulesText(),initial_tape:this.gui.initial_tape,rulesNo:this.gui.rulesNo,max_len:this.gui.max_len,tape_len:this.gui.tape_len,step_count:this.gui.step_count,LEFT:t,RIGHT:e,BLANK:n,INIT_STATE:s,HALT_STATE:r,COMMENT_PREFIX:i,MAX_STATES:o,MAX_TAPE_LEN:u,MAX_STATE_SIZE:m,TRANSITION_SIZE:E,history:this.gui.history,...c,stepBtn:document.getElementById("stepBtn").disabled,RunPauseBtn:document.getElementById("RunPauseBtn").disabled,ControlBtn:((S=document.getElementById("ControlBtn"))==null?void 0:S.className)||""}}async loadJSON(t){return new Promise((e,n)=>{if(!t){n(new Error("No file provided"));return}const s=new FileReader;s.onload=r=>{try{const i=JSON.parse(r.target.result);if(!i||typeof i!="object")throw new Error("Invalid file format");e(i)}catch(i){console.error("Error loading state file:",i),alert(`Error loading file: ${i.message}`),n(i)}},s.onerror=()=>{n(new Error("Error reading file"))},s.readAsText(t)})}async loadJSONLines(t){if(!t)throw new Error("No file provided");const n=(await t.text()).split(`
`).filter(i=>i.trim());if(n.length===0)throw new Error("File is empty");let s;try{s=JSON.parse(n[0])}catch(i){throw new Error(`Invalid metadata (line 1): ${i.message}`)}if(n.length>1){s.history=[];for(let i=1;i<n.length;i++)try{const o=JSON.parse(n[i]);s.history.push(o)}catch(o){console.warn(`Skipping invalid history entry (line ${i+1})`,o)}}const r=["INIT_STATE","HALT_STATE","tape","current_state"];for(const i of r)if(s[i]===void 0)throw new Error(`Missing required field: ${i}`);return s}loadRules(t){return new Promise((e,n)=>{if(!t){n("No file provided");return}const s=new FileReader;s.onload=r=>{try{const i=r.target.result.trim();e(i)}catch(i){n(i)}},s.onerror=n,s.readAsText(t)})}async loadYAML(t){return new Promise((e,n)=>{if(!t){n(new Error("No file provided"));return}const s=new FileReader;s.onload=r=>{try{const i=jsyaml.load(r.target.result);if(!i||typeof i!="object")throw new Error("Invalid YAML format");e(i)}catch(i){console.error("Error parsing YAML:",i),alert(`Error loading YAML file: ${i.message}`),n(i)}},s.onerror=()=>{n(new Error("Error reading YAML file"))},s.readAsText(t)})}exportFileData(t){let e="";switch(t){case"txt":e=this.getRulesText();break;case"json":e=JSON.stringify(this.saveState(),null,2);break;case"jsonl":const n=this.saveState(),{history:s,...r}=n,i=[JSON.stringify(r)];s!=null&&s.length&&s.forEach(o=>i.push(JSON.stringify(o))),e=i.join(`
`);break;case"yaml":e=jsyaml.dump(this.saveState());break;default:console.warn("Unknown export format selected")}return e}downloadFile(t,e){return new Promise((n,s)=>{let r;switch(e){case"json":r="application/json";break;case"jsonl":r="application/x-ndjson";break;case"txt":r="text/plain";break;case"yaml":r="text/yaml";break;default:s(new Error(`Unsupported file type: ${e}`));return}const i=new Blob([t],{type:r}),o=URL.createObjectURL(i),u=document.createElement("a");u.href=o,u.download=`${this.gui.modelName}.${e}`,document.body.appendChild(u),u.click(),document.body.removeChild(u),URL.revokeObjectURL(o),n()})}}class B{constructor(){T(this,"docIDs",["stepBtn","RunPauseBtn","resetBtn","ControlBtn","gotoBtn","gotoStep","stepEntry","maxSteps","historySlider","tapeInput","tapeDisplay","clearTapeBtn","copyTapeBtn","rulesText","clearRulesBtn","copyRulesBtn","modelInputName","stepState","machineStatus","results","resources","importModal","exportModal","importBtn","exportBtn","saveBtn","delayEntry"]);this.init_time=l.getTimestamp(),this.auto_run_timeout=null,this.running=!1,this.modelName=" ",this.step_count=0,this.hasStarted=!1,this.errorState=!1,this.halted=!1,this.MAX_STEPS=1e6,this.BASE_STEP=1,this.history=[],this.DELAY=0,this.initElements(),this.setupEventListeners(),this.setupModalHandlers(),this.stateManager=new nt(this,window.getRulesText,window.setRulesText)}initElements(){for(const t of this.docIDs)this[t]=document.getElementById(t)}delElements(){this.docIDs.forEach(t=>{const e=document.getElementById(t);if(e){const n=e.cloneNode(!0);e.parentNode.replaceChild(n,e)}})}setupEventListeners(){var e,n;const t=s=>(...r)=>{s(...r),window.scrollTo({top:0,behavior:"smooth"})};this.modelInputName.addEventListener("input",()=>{this.modelName=this.modelInputName.value.trim()||"turing_test"}),this.resetBtn.addEventListener("click",t(()=>this.reset())),this.gotoBtn.addEventListener("click",t(()=>this.goToStep())),this.stepBtn.addEventListener("click",t(()=>this.step())),this.historySlider.addEventListener("input",t(()=>this.seekHistory(parseInt(this.historySlider.value)))),this.RunPauseBtn.addEventListener("click",t(()=>{this.running?this.pause():this.run()})),this.ControlBtn&&this.ControlBtn.addEventListener("click",()=>{this.running?this.pause():this.run()}),this.updateControlButton("run"),this.copyRulesBtn.addEventListener("click",()=>{this.stateManager.copyText(window.getRulesText(),"Transition rules")}),this.clearRulesBtn.addEventListener("click",()=>{this.stateManager.clearText(null,"all transition rules",window.setRulesText.bind(this))}),this.copyTapeBtn.addEventListener("click",()=>{this.stateManager.copyText(this.tapeInput,"Initial Tape")}),this.clearTapeBtn.addEventListener("click",()=>{this.stateManager.clearText("tapeInput","initial Tape")}),(e=this.importBtn)==null||e.addEventListener("click",()=>this.handleImports()),(n=this.exportBtn)==null||n.addEventListener("click",()=>this.handleExports())}toggleModal(t,e){t&&(t.classList.toggle("active",e),document.body.style.overflow=e?"hidden":"")}setupModalHandlers(){var e,n;(e=this.importBtn)==null||e.addEventListener("click",()=>this.toggleModal(this.importModal,!0)),(n=this.exportBtn)==null||n.addEventListener("click",()=>this.toggleModal(this.exportModal,!0));const t=()=>{this.toggleModal(this.importModal,!1),this.toggleModal(this.exportModal,!1)};document.querySelectorAll(".tm-modal-close").forEach(s=>{s.addEventListener("click",t)}),[this.importModal,this.exportModal].forEach(s=>{s==null||s.addEventListener("click",r=>{r.target===s&&t()})})}handleImports(){const t=document.getElementById("fileInput"),e=document.getElementById("importPreview"),n=document.getElementById("importConfirmBtn"),s=document.getElementById("filePreviewContainer"),r=document.getElementById("closeImport");let i=null,o="",u="";function m(){s.innerHTML="",i=null,o="",e.value="",n.disabled=!0}function E(d){const h=document.createElement("div");h.className="tm-file-preview-chip";const w=document.createElement("span");w.textContent=d.name;const b=document.createElement("button");b.type="button",b.innerHTML="&times;",b.title="Remove file",b.addEventListener("click",()=>{m(),t.value=""}),h.appendChild(w),h.appendChild(b),s.appendChild(h),n.disabled=!1}function f(d){if(!d.length)return;d.length>=2&&alert("Multiple files selected. Select a single file model");const h=d[0],w=["json","jsonl","yaml","txt"],b=h.name.split(".").pop().toLowerCase();if(!w.includes(b)){alert("Unsupported file type"),m();return}return m(),i=h,o=b,E(h),i}document.querySelectorAll(".tm-option-card").forEach(d=>{d.addEventListener("click",()=>{t.accept=`.${d.dataset.type}`,t.click()})});const c=document.querySelector(".tm-file-dropzone");if(c){let d=function(h){h.preventDefault(),h.stopPropagation()};var S=d;c.addEventListener("click",()=>t.click()),["dragenter","dragover","dragleave","drop"].forEach(h=>c.addEventListener(h,d,!1)),["dragenter","dragover"].forEach(h=>c.addEventListener(h,()=>c.classList.add("highlight"),!1)),["dragleave","drop"].forEach(h=>c.addEventListener(h,()=>c.classList.remove("highlight"),!1)),c.addEventListener("drop",h=>f(h.dataTransfer.files),!1)}t.addEventListener("change",async d=>{if(i=f(d.target.files),d.target.value="",o==="json")u=await this.stateManager.loadJSON(i),e.value=JSON.stringify(u,null,2);else if(o==="jsonl")u=await this.stateManager.loadJSONLines(i),e.value=JSON.stringify(u,null,2);else if(o==="yaml")u=await this.stateManager.loadYAML(i),e.value=jsyaml.dump(u);else if(o==="txt")u=await this.stateManager.loadRules(i),e.value=u;else throw new Error("Unsupported file type")}),n.addEventListener("click",async()=>{if(!i){alert("No file selected");return}const d=i.name.replace(/\.[^/.]+$/,"");document.getElementById("modelInputName").value=d,this.modelName=d,o==="txt"?window.setRulesText(u):this.loadState(u),this.updateMachineStatus(`Modell '${d}' geladen`,"text-success")}),r.addEventListener("click",()=>{m()})}loadState(t){var u,m,E,f;Object.entries({LEFT:["leftSymbolInput","L"],RIGHT:["rightSymbolInput","R"],BLANK:["blankSymbolInput","_"],INIT_STATE:["initStateInput","INIT"],HALT_STATE:["haltStateInput","HALT"],COMMENT_PREFIX:["commentSymbolInput","//"],MAX_STATES:["maxStatesInput",1024],MAX_STATE_SIZE:["maxStateSizeInput",32],MAX_TAPE_LEN:["maxTapeLenInput",1048576],TRANSITION_SIZE:["transitionSizeInput",71e4]}).forEach(([c,[S,d]])=>{const h=t[c]!==void 0&&t[c]!==""?t[c]:d,w=document.getElementById(S);w&&(w.value=h)}),l.updateFromInputs();const n={tape:[],input_tape:"",running:!1,head_position:0,current_state:""},s=t.rulesText||"";window.setRulesText(s);const r=new l().parseTransitionRules(t.rulesText),i=new MachineLogic(r,t.INIT_STATE,t.HALT_STATE);this.cpu=i,Object.keys(n).forEach(c=>{this.cpu[c]=t[c]??n[c]});const o={rulesNo:0,max_len:0,tape_len:0,history:[],step_count:0,initial_tape:"",running:!1};return Object.keys(o).forEach(c=>{this[c]=t[c]??o[c]}),this.hasStarted=!!this.running||(this.step_count??0)>0||(((u=this.history)==null?void 0:u.length)??0)>1,this.errorState=!1,this.halted=((m=this.cpu)==null?void 0:m.current_state)===((E=this.cpu)==null?void 0:E.halt_state),this.tapeInput&&(this.tapeInput.value=this.initial_tape),this.ControlBtn&&((f=t.ControlBtn)!=null&&f.split(" ").includes("btn-reset"))?this.updateControlButton("reset"):this.pause(!1),this.stepBtn.disabled=t.stepBtn??!1,this.RunPauseBtn.disabled=t.RunPauseBtn??!1,this.updateUI(),this.updateResults(),!0}reset(){try{clearTimeout(this.auto_run_timeout),l.updateFromInputs();const t=window.getRulesText();this.initial_tape=this.tapeInput.value,this.init_time=l.getTimestamp();const e=new l().parseTransitionRules(t);this.cpu=new MachineLogic(e),this.cpu._setTape(this.initial_tape),this.max_len=0,this.tape_len=0,this.step_count=0,this.running=!1,this.hasStarted=!1,this.errorState=!1,this.halted=!1,this.stepBtn.disabled=!1,this.ControlBtn&&(this.ControlBtn.disabled=!1),this.RunPauseBtn.disabled=!1,this.updateControlButton("run"),this.updateMachineStatus(`Modell '${this.modelName}' geladen`,"text-secondary"),this.rulesNo=this.cpu.transitions_list.length,this.history=[{tape:{...this.cpu.tape},head:this.cpu.head_position,state:this.cpu.current_state,move:"N"}],this.updateUI(),this.updateResults()}catch(t){console.error("Load error:",t),this.updateMachineStatus(t,"text-danger")}}ensureMachineLoadedForStart(){var s,r;const t=!this.cpu,e=!this.hasStarted&&this.step_count===0&&!this.running,n=this.halted||((s=this.cpu)==null?void 0:s.current_state)===((r=this.cpu)==null?void 0:r.halt_state);return this.errorState||n||t||e?(this.reset(),!0):!1}step(t=!0){var e,n;try{this.ensureMachineLoadedForStart(),this.hasStarted=!0;const s=parseInt((e=this.stepEntry)==null?void 0:e.value)||this.BASE_STEP,r=parseInt((n=this.maxSteps)==null?void 0:n.value)||this.MAX_STEPS;t&&this.updateMachineStatus(`Maschine gelaufen für ${s} Schritte`,"text-primary");for(let i=0;i<s;i++){if(this.step_count>=r){this.updateMachineStatus(`Max steps (${r}) reached`,"text-danger"),this.pause(!1);break}if(this.cpu.current_state===this.cpu.halt_state){this.HALT(!0);break}try{if(this.cpu._stepLogic(),this.step_count++,this.history[this.step_count-1].move=this.cpu.headMove,this.tape_len=Object.keys(this.cpu.tape).length,this.max_len=Math.max(this.max_len,this.tape_len),this.history.push({tape:{...this.cpu.tape},head:this.cpu.head_position,state:this.cpu.current_state,move:"N",tape_len:this.tape_len}),this.updateUI(),this.updateResults(),this.cpu.current_state===this.cpu.halt_state){this.HALT(!0);break}}catch(o){const u=`Maschine FESTGEFAHREN | Nach ${this.step_count} Schritten`;throw this.updateMachineStatus(u,"text-danger"),this.pause(!1),this.errorState=!0,o}}}catch(s){console.error("Step error:",s),this.updateMachineStatus(`Fehler: ${s.message}`,"text-danger"),this.errorState=!0}}pause(t=!0){t&&this.updateMachineStatus(`Maschine pausiert nach ${this.step_count} Schritten`,"text-warning"),this.running=!1,clearTimeout(this.auto_run_timeout),this.updateControlButton("run"),this.stepBtn.disabled=!1}HALT(t=!1){this.running=!1,this.halted=!0,this.stepBtn.disabled=t,this.RunPauseBtn.disabled=!1,this.updateControlButton("reset");const e=`Maschine ANGEHALTEN | Schritte gesamt: ${this.step_count}`;this.updateMachineStatus(e,"text-success")}run(){this.ensureMachineLoadedForStart(),this.hasStarted=!0,this.running=!0,this.stepBtn.disabled=!0,this.updateControlButton("pause"),this.autoStep()}autoStep(){if(!this.running)return;if(this.cpu.current_state===this.cpu.halt_state){this.HALT(!1);return}this.updateMachineStatus("Maschine läuft","text-primary"),this.step(!1);const t=parseInt(this.delayEntry.value)||this.DELAY;this.auto_run_timeout=setTimeout(()=>this.autoStep(),t)}seekHistory(t){if(t=parseInt(t),isNaN(t)||t<0||t>=this.history.length)return;const e=this.history[t];this.cpu.tape={...e.tape},this.cpu.head_position=e.head,this.cpu.current_state=e.state,this.step_count=t,this.updateUI()}goToStep(){const t=parseInt(this.gotoStep.value);if(isNaN(t)){alert("Please enter a valid step number");return}if(t<0||t>this.history.length-1){alert(`Step must be between 0 and ${this.history.length-1}`);return}this.historySlider.value=t,this.seekHistory(t)}updateUI(){this.tapeDisplay.innerHTML="";const t=Object.keys(this.cpu.tape).map(Number),e=t.length>0?Math.min(...t):0,n=t.length>0?Math.max(...t):0,s=Math.min(e,this.cpu.head_position)-7,r=Math.max(n,this.cpu.head_position)+7;for(let o=s;o<=r;o++){const u=document.createElement("div");u.className="tape-cell",u.textContent=this.cpu.tape[o]!==void 0?this.cpu.tape[o]:this.cpu.blank_symbol,o===this.cpu.head_position&&u.classList.add("active"),this.tapeDisplay.appendChild(u)}const i=this.tapeDisplay.querySelector(".active");i&&i.scrollIntoView({behavior:"auto",block:"nearest",inline:"center"}),window.scrollTo(0,scrollY),this.historySlider.max=this.history.length-1,this.historySlider.value=this.step_count,this.gotoStep.value=this.step_count,this.updateStepState()}updateResults(){if(!this.results)return;this.cpu.stepCount=this.step_count;const t=this.cpu._printTapeState(),e=[`    Time run: ${(l.getTimestamp()-this.init_time).toFixed(5)}s`,` Memory used: ${l.getCurrentMemoryMB()}MB`],n=[`   Tape Size: Max = ${this.max_len} | Now = ${this.tape_len} `,`Initial Tape: '${this.initial_tape}'`,` Result Tape: '${t}'`,` Steps Count: ${this.step_count}`,` Total Rules: ${this.rulesNo}`,...e];this.results.innerHTML=n.join("<br>")}updateStepState(){const t=parseInt(this.historySlider.value),e=t>0?this.history[t-1].state:"--",n=this.history[t].state,s=t+1<this.history.length?this.history[t+1].state:(t===this.step_count,"--");this.stepState.innerHTML=` Schritt [${t}]: ${e} <- <span class="tape-current">${n}</span> -> ${s}`}updateControlButton(t){const e=this.ControlBtn,n=this.RunPauseBtn;switch(n.className="btn w-100 action-btn",e&&(e.className="control-btn"),t){case"run":e&&(e.classList.add("btn-run"),e.innerHTML='<i class="bi bi-play-fill"></i>'),n.classList.add("btn-run"),n.innerHTML='<i class="w-100 bi bi-play-fill"></i>Start';break;case"pause":e&&(e.classList.add("btn-pause"),e.innerHTML='<i class="bi bi-pause-fill"></i>'),n.classList.add("btn-pause"),n.innerHTML='<i class="w-100 bi bi-pause-fill"></i>Stop';break;case"reset":e&&(e.classList.add("btn-reset"),e.innerHTML='<i class="bi bi-arrow-clockwise"></i>'),n.classList.add("btn-run"),n.innerHTML='<i class="w-100 bi bi-play-fill"></i>Start';break}}updateMachineStatus(t,e="text-primary"){const n=this.machineStatus;n.className=`machineStatus fw-bold text-center ${e}`,n.textContent=t}handleExports(){const t=document.getElementById("exportPreview"),e=document.querySelectorAll('input[name="exportFormat"]'),n=document.getElementById("closeExport");let s="",r="";e.forEach(i=>{i.addEventListener("change",()=>{r=document.querySelector('input[name="exportFormat"]:checked').value,s=this.stateManager.exportFileData(r),t.value=s})}),this.saveBtn.addEventListener("click",()=>{this.stateManager.downloadFile(s,r)}),n.addEventListener("click",()=>{e.forEach(i=>{i.checked=!1}),t.value=""})}}window.TuringConfig=l;window.MachineLogic=et;window.Simulator_GUI=B;const _=ace.edit("rulesEditor");_.setTheme("ace/theme/KatzenMilch");_.session.setMode("ace/mode/text");_.setOptions({fontSize:"13px",showLineNumbers:!0,showGutter:!0,cursorStyle:"ace",highlightActiveLine:!0,enableBasicAutocompletion:!0,enableLiveAutocompletion:!0});window.getRulesText=()=>_.getValue();window.setRulesText=a=>{_.setValue(a,-1),_.clearSelection();const t=_.session.getLength()-1,e=_.session.getLine(t).length;_.gotoLine(t+1,e,!1)};let g=new B;const st=()=>{var t;return(((t=document.getElementById("default-link"))==null?void 0:t.getAttribute("href"))||"/").replace(/\/$/,"")},v=a=>{if(!a)return"";const t=st();return a.startsWith("/")?t+a:`${t}/${a}`},it=()=>{var t,e;return((e=(t=document.getElementById("student-dashboard-link"))==null?void 0:t.getAttribute("href"))==null?void 0:e.trim())||""||v("/student/dashboard")},at=()=>{const a=it();a&&window.location.assign(a)},y=(a,t,e)=>{const n=document.getElementById("save-status");n&&(n.className=`fas fa-circle ${e}`,n.setAttribute("data-title",t),n.setAttribute("title",t),n.setAttribute("data-status",a))},M=(a,t="")=>{const e=document.getElementById(a);return e?e.value:t},rt=()=>(l.updateFromInputs(),{LEFT:l.LEFT,RIGHT:l.RIGHT,BLANK:l.BLANK,INIT_STATE:l.INIT_STATE,HALT_STATE:l.HALT_STATE,COMMENT_PREFIX:l.COMMENT_PREFIX,MAX_STATES:l.MAX_STATES,MAX_TAPE_LEN:l.MAX_TAPE_LEN,MAX_STATE_SIZE:l.MAX_STATE_SIZE,TRANSITION_SIZE:l.TRANSITION_SIZE}),ot=()=>{var a;return JSON.stringify({version:1,rulesText:((a=window.getRulesText)==null?void 0:a.call(window))||"",tape:M("tapeInput",""),speed:parseInt(M("delayEntry","0"),10)||0,modelName:M("modelInputName","").trim(),config:rt()})},lt=(a={})=>{const t={LEFT:"leftSymbolInput",RIGHT:"rightSymbolInput",BLANK:"blankSymbolInput",INIT_STATE:"initStateInput",HALT_STATE:"haltStateInput",COMMENT_PREFIX:"commentSymbolInput",MAX_STATES:"maxStatesInput",MAX_TAPE_LEN:"maxTapeLenInput",MAX_STATE_SIZE:"maxStateSizeInput",TRANSITION_SIZE:"transitionSizeInput"};Object.entries(t).forEach(([e,n])=>{if(a[e]===void 0)return;const s=document.getElementById(n);s&&(s.value=a[e])}),Object.keys(t).forEach(e=>{a[e]!==void 0&&(l[e]=a[e])})},A=()=>{var i,o;const a=document.getElementById("initStateInput"),t=document.getElementById("haltStateInput"),e=((i=a==null?void 0:a.value)==null?void 0:i.trim())||(l==null?void 0:l.INIT_STATE)||"—",n=((o=t==null?void 0:t.value)==null?void 0:o.trim())||(l==null?void 0:l.HALT_STATE)||"—",s=document.getElementById("startStateDisplay"),r=document.getElementById("haltStateDisplay");s&&(s.textContent=e),r&&(r.textContent=n)},q=a=>typeof a=="string"?[a]:Array.isArray(a)?a.filter(t=>typeof t=="string"):[],x=a=>{var e;if(!a)return;let t;try{t=typeof a=="string"?JSON.parse(a):a}catch(n){console.warn("Content parse failed, ignoring.",n);return}if(t.config&&lt(t.config),t.rulesText!==void 0&&((e=window.setRulesText)==null||e.call(window,t.rulesText)),t.modelName!==void 0){const n=document.getElementById("modelInputName");n&&(n.value=t.modelName),t.modelName&&(g.modelName=t.modelName)}if(t.tape!==void 0){const n=document.getElementById("tapeInput");if(n){if(typeof t.tape=="string")n.value=t.tape;else if(Array.isArray(t.tape)){const s=q(t.tape);s.length>0&&(n.value=s[0])}}}if(t.speed!==void 0){const n=document.getElementById("delayEntry");n&&(n.value=t.speed)}A(),y("ready","Bereit zum Speichern","text-muted")},ut=()=>{var n,s;const a=((s=(n=document.getElementById("description"))==null?void 0:n.textContent)==null?void 0:s.trim())||"",t=document.getElementById("taskDescriptionCard"),e=document.getElementById("taskDescriptionContent");!t||!e||!a||(window.marked&&typeof window.marked.parse=="function"?e.innerHTML=window.marked.parse(a):e.textContent=a,t.classList.remove("d-none"))},Y=async(a=!1)=>{var s,r,i,o;const t=((r=(s=document.getElementById("task-save-url"))==null?void 0:s.dataset)==null?void 0:r.url)||"",e=((o=(i=document.getElementById("task-submit-url"))==null?void 0:i.dataset)==null?void 0:o.url)||"",n=v(a?e:t);if(!n){y("error","Keine Ziel-URL gefunden","text-danger");return}y("saving","Speichert...","text-primary");try{(await fetch(n,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({content:ot()})})).ok?y(a?"submitted":"saved",a?"Abgegeben":"Gespeichert","text-success"):y("error","Fehler beim Speichern","text-danger")}catch{y("error","Fehler beim Speichern","text-danger")}},ct=()=>{confirm("Möchten Sie diese Aufgabe wirklich abgeben?")&&Y(!0)};var F,P;const $=((P=(F=document.getElementById("currentContent"))==null?void 0:F.textContent)==null?void 0:P.trim())||"";var H,O;const k=((O=(H=document.getElementById("defaultSubmission"))==null?void 0:H.textContent)==null?void 0:O.trim())||"",dt=()=>{if(!k)return null;try{return JSON.parse(k)}catch(a){return console.warn("Default submission parse failed, ignoring.",a),null}},I=dt(),W=typeof(I==null?void 0:I.rulesText)=="string"?I.rulesText:"",N=W.trim().length>0,ht=q(I==null?void 0:I.tape),L=ht.filter(a=>a.trim().length>0),R=L.length>0,pt=()=>{if(!N){y("error","Keine Basislösung zum Zurücksetzen gefunden","text-danger");return}confirm("Möchten Sie wirklich auf die vorgegebene Basislösung zurücksetzen?")&&(x({rulesText:W}),g.reset(),y("ready","Basislösung geladen (bitte speichern)","text-muted"))},mt=()=>{if(!R){y("error","Kein Standardband zum Laden gefunden","text-danger");return}const a=document.getElementById("tapeInput");if(!a)return;const t=a.value,e=L.findIndex(s=>s===t),n=e>=0?(e+1)%L.length:0;a.value=L[n],a.dispatchEvent(new Event("input",{bubbles:!0}))};$?x($):I&&x(I);ut();const ft=()=>{var r,i,o;const a=((r=window.getRulesText)==null?void 0:r.call(window))||"";l.updateFromInputs();const t=l.INIT_STATE,e=l.HALT_STATE,n=l.BLANK,s=`${t} ${n} ${e} ${n} R`;(i=window.setRulesText)==null||i.call(window,s),g.reset(),(o=window.setRulesText)==null||o.call(window,a),g.updateUI(),g.updateStepState(),g.updateMachineStatus("Turingsimulator bereit","text-secondary")};ft();A();var D;(D=document.getElementById("initStateInput"))==null||D.addEventListener("input",A);var X;(X=document.getElementById("haltStateInput"))==null||X.addEventListener("input",A);var j;(j=document.getElementById("saveButton"))==null||j.addEventListener("click",()=>Y(!1));var U;(U=document.getElementById("submitButton"))==null||U.addEventListener("click",ct);var Z;N&&((Z=document.getElementById("resetDefaultButton"))==null||Z.addEventListener("click",pt));if(R){const a=document.getElementById("cycleDefaultTapeBtn");a&&(a.classList.remove("d-none"),a.title=L.length>1?"Nächstes Standardband laden":"Standardband laden",a.addEventListener("click",mt))}var z;(z=document.getElementById("dashboardButton"))==null||z.addEventListener("click",at);var G,J;const gt=((J=(G=document.getElementById("task-submit-url"))==null?void 0:G.dataset)==null?void 0:J.url)||"";if(!gt){const a=document.getElementById("submitButton");a&&(a.disabled=!0,a.title="Abgabe im Lehrer-View deaktiviert")}if(!N){const a=document.getElementById("resetDefaultButton");a&&a.classList.add("d-none")}if(!R){const a=document.getElementById("cycleDefaultTapeBtn");a&&a.classList.add("d-none")}const C=()=>y("ready","Bereit zum Speichern","text-muted");_.session.on("change",C);var K;(K=document.getElementById("tapeInput"))==null||K.addEventListener("input",C);var V;(V=document.getElementById("delayEntry"))==null||V.addEventListener("input",C);window.applyConfig=function(){confirm("Are you sure you want to completely re-configure the Turing Simulator?")&&(l.updateFromInputs(),g.delElements(),window.simulator&&typeof g.destroy=="function"&&g.destroy(),g=new B,g.modelName=g.modelInputName.value.trim(),g.reset())};
