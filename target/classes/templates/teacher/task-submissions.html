
<!DOCTYPE html>
<html lang="de" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aufgaben-Abgaben - Schüler-Aufgaben-System</title>
    <link th:href="@{/webjars/bootstrap/css/bootstrap.min.css}" rel="stylesheet">
    <link th:href="@{/css/custom.css}" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fas fa-graduation-cap"></i> Aufgaben-System</a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" th:href="@{/teacher/dashboard}">
                    <i class="fas fa-home"></i> Dashboard
                </a>
                <a class="nav-link" th:href="@{/logout}">
                    <i class="fas fa-sign-out-alt"></i> Abmelden
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/teacher/dashboard}">Dashboard</a></li>
                <li class="breadcrumb-item"><a th:href="@{/teacher/tasks}">Aufgaben</a></li>
                <li class="breadcrumb-item active" aria-current="page">Abgaben</li>
            </ol>
        </nav>

        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h2><i class="fas fa-clipboard-list"></i> Aufgaben-Abgaben</h2>
                        <h4 class="text-muted" th:text="${task.title}">Aufgabentitel</h4>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-info fs-6" th:text="${submissions.size()} + ' Schüler'">0 Schüler</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aufgaben-Info -->
        <div class="row mb-4">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-info-circle"></i> Aufgaben-Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <p><strong>Erstellt am:</strong> <span th:text="${#temporals.format(task.createdAt, 'dd.MM.yyyy HH:mm')}">01.01.2024 10:00</span></p>
                                <p><strong>Fällig am:</strong> <span th:text="${task.dueDate != null ? #temporals.format(task.dueDate, 'dd.MM.yyyy HH:mm') : 'Kein Fälligkeitsdatum'}">01.02.2024 23:59</span></p>
                            </div>
                            <div class="col-md-6">
                                <p><strong>Aufgaben-Typ:</strong> <span th:text="${task.taskView != null ? task.taskView.name : 'Standard'}">HTML Editor</span></p>
                                <p><strong>Status:</strong> 
                                    <span th:if="${task.isActive}" class="badge bg-success">Aktiv</span>
                                    <span th:unless="${task.isActive}" class="badge bg-secondary">Inaktiv</span>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Submissions Liste -->
        <div class="row">
            <div class="col">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0"><i class="fas fa-users"></i> Schüler-Abgaben</h5>
                    </div>
                    <div class="card-body">
                        <div th:if="${submissions != null and !submissions.isEmpty()}">
                            <div th:each="submission : ${submissions}" class="border rounded p-3 mb-3">
                                <!-- Schüler-Header -->
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <div>
                                        <h6 class="mb-1">
                                            <i class="fas fa-user"></i> 
                                            <span th:text="${submission.student.name}">Max Mustermann</span>
                                            <small class="text-muted" th:text="'(' + ${submission.student.email} + ')'">
                                                (max@school.de)
                                            </small>
                                        </h6>
                                        <small class="text-muted" th:if="${submission.lastActivity != null}" 
                                               th:text="'Letzte Aktivität: ' + ${#temporals.format(submission.lastActivity, 'dd.MM.yyyy HH:mm')}">
                                            Letzte Aktivität: 15.01.2024 14:30
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span th:if="${submission.status.name == 'NICHT_BEGONNEN'}" class="badge bg-secondary">Nicht begonnen</span>
                                        <span th:if="${submission.status.name == 'IN_BEARBEITUNG'}" class="badge bg-primary">In Bearbeitung</span>
                                        <span th:if="${submission.status.name == 'ABGEGEBEN'}" class="badge bg-success">Abgegeben</span>
                                        <span th:if="${submission.status.name == 'ÜBERARBEITUNG_NÖTIG'}" class="badge bg-warning">Überarbeitung nötig</span>
                                        <span th:if="${submission.status.name == 'VOLLSTÄNDIG'}" class="badge bg-info">Vollständig</span>
                                        <br>
                                        <small class="text-muted" th:text="${submission.submissionCount} + ' Versionen'">3 Versionen</small>
                                    </div>
                                </div>

                                <!-- Submission-Historie (ausklappbar) -->
                                <div th:if="${submission.hasSubmissions}">
                                    <div class="accordion" th:id="'accordion-' + ${submission.userTask.id}">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" 
                                                        data-bs-toggle="collapse" 
                                                        th:data-bs-target="'#collapse-' + ${submission.userTask.id}"
                                                        aria-expanded="false">
                                                    <i class="fas fa-history me-2"></i>
                                                    Versions-Historie anzeigen
                                                </button>
                                            </h2>
                                            <div th:id="'collapse-' + ${submission.userTask.id}" 
                                                 class="accordion-collapse collapse" 
                                                 th:data-bs-parent="'#accordion-' + ${submission.userTask.id}">
                                                <div class="accordion-body">
                                                    <div class="timeline">
                                                        <div th:each="content,iterStat : ${submission.submissionHistory}" 
                                                             class="timeline-item mb-3">
                                                            <div class="d-flex align-items-start">
                                                                <div class="timeline-marker me-3">
                                                                    <span th:if="${content.isSubmitted}" class="badge bg-success rounded-pill">
                                                                        <i class="fas fa-check"></i>
                                                                    </span>
                                                                    <span th:unless="${content.isSubmitted}" class="badge bg-secondary rounded-pill">
                                                                        <i class="fas fa-save"></i>
                                                                    </span>
                                                                </div>
                                                                <div class="timeline-content flex-grow-1">
                                                                    <div class="d-flex justify-content-between align-items-center">
                                                                        <div>
                                                                            <h6 class="mb-1">
                                                                                Version <span th:text="${content.version}">1</span>
                                                                                <span th:if="${content.isSubmitted}" class="text-success ms-2">
                                                                                    <i class="fas fa-paper-plane"></i> Abgegeben
                                                                                </span>
                                                                                <span th:unless="${content.isSubmitted}" class="text-muted ms-2">
                                                                                    <i class="fas fa-save"></i> Gespeichert
                                                                                </span>
                                                                            </h6>
                                                                            <small class="text-muted" 
                                                                                   th:text="${#temporals.format(content.savedAt, 'dd.MM.yyyy HH:mm:ss')}">
                                                                                15.01.2024 14:30:15
                                                                            </small>
                                                                        </div>
                                                                        <div>
                                                                            <button class="btn btn-sm btn-outline-primary" 
                                                                                    onclick="showContentPreview(this)"
                                                                                    th:data-content="${content.content}"
                                                                                    th:data-version="${content.version}">
                                                                                <i class="fas fa-eye"></i> Ansehen
                                                                            </button>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Falls keine Submissions vorhanden -->
                                <div th:unless="${submission.hasSubmissions}" class="text-center py-3 text-muted">
                                    <i class="fas fa-inbox fa-2x mb-2"></i>
                                    <p>Noch keine Abgaben vorhanden</p>
                                </div>

                                <!-- Quick Actions -->
                                <div class="mt-3 pt-3 border-top">
                                    <div class="btn-group btn-group-sm" role="group">
                                        <button class="btn btn-outline-success" th:if="${submission.status.name != 'VOLLSTÄNDIG'}">
                                            <i class="fas fa-check"></i> Als vollständig markieren
                                        </button>
                                        <button class="btn btn-outline-warning" th:if="${submission.status.name != 'ÜBERARBEITUNG_NÖTIG'}">
                                            <i class="fas fa-edit"></i> Überarbeitung anfordern
                                        </button>
                                        <button class="btn btn-outline-info">
                                            <i class="fas fa-comment"></i> Kommentar hinzufügen
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Falls keine Submissions vorhanden -->
                        <div th:if="${submissions == null or submissions.isEmpty()}" class="text-center py-5">
                            <i class="fas fa-inbox fa-4x text-muted mb-3"></i>
                            <h5 class="text-muted">Noch keine Schüler-Abgaben</h5>
                            <p class="text-muted">Schüler müssen erst mit der Bearbeitung dieser Aufgabe beginnen.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Content Preview Modal -->
    <div class="modal fade" id="contentPreviewModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Inhalt anzeigen - Version <span id="modalVersion"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <pre id="modalContent" class="bg-light p-3 rounded" style="max-height: 400px; overflow-y: auto;"></pre>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Schließen</button>
                </div>
            </div>
        </div>
    </div>

    <script th:src="@{/webjars/bootstrap/js/bootstrap.bundle.min.js}"></script>
    
    <script>
        function showContentPreview(button) {
            const content = button.getAttribute('data-content');
            const version = button.getAttribute('data-version');
            
            document.getElementById('modalVersion').textContent = version;
            document.getElementById('modalContent').textContent = content;
            
            const modal = new bootstrap.Modal(document.getElementById('contentPreviewModal'));
            modal.show();
        }
    </script>

    <style>
        .timeline-marker {
            width: 30px;
        }
        
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: 15px;
            width: 2px;
            height: 20px;
            background-color: #dee2e6;
            margin-top: 30px;
        }
        
        .timeline-item {
            position: relative;
        }
    </style>
</body>
</html>
